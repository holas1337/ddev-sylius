#!/usr/bin/env bash
set -euo pipefail

RED="\e[31m"
GREEN="\e[32m"
ENDCOLOR="\e[0m"

if [ -n "${1:-}" ]; then
  SYLIUS_VERSION="$1"
else
  printf "%b\n" "${GREEN}No Sylius version parameter provided.${ENDCOLOR}"
  printf "%b\n" "${GREEN}Enter Sylius version to install (e.g. '^2.1' or '2.1.3') or press Enter for newest:${ENDCOLOR}"
  read -r -p "> " USER_SYLIUS_VERSION
  if [ -z "${USER_SYLIUS_VERSION}" ]; then
    # Empty means install the newest available (omit version in composer)
    SYLIUS_VERSION=""
    printf "%b\n" "${GREEN}Installing newest Sylius version.${ENDCOLOR}"
  else
    SYLIUS_VERSION="${USER_SYLIUS_VERSION}"
    printf "%b\n" "${GREEN}Installing Sylius version: ${SYLIUS_VERSION}${ENDCOLOR}"
  fi
fi

# DDEV provides DDEV_APPROOT when running host commands; validate it
if [ -z "${DDEV_APPROOT:-}" ]; then
  printf "%b\n" "${RED}DDEV_APPROOT is not set. Are you running this as a DDEV host command?${ENDCOLOR}"
  exit 1
fi

DDEV_APP_FILES_DIR="${DDEV_APPROOT}/.ddev/_files"
APP_DIR="${DDEV_APPROOT}/App"
APP_SUBDIR="App"

# Ensure ddev is available on the host
if ! command -v ddev >/dev/null 2>&1; then
  printf "%b\n" "${RED}ddev command not found in PATH. Install DDEV and retry.${ENDCOLOR}"
  exit 1
fi

if [ -f "${DDEV_APPROOT}/composer.json" ]; then
  printf "%b\n" "${RED}Sylius appears to already be installed (found ${DDEV_APPROOT}/composer.json). Run ddev sylius-cleanup and start again.${ENDCOLOR}"
  exit 1
fi

### Creating required directories
mkdir -p "${APP_DIR}"

### Create sylius project (run composer inside the web container, target current dir '.')
if [ -n "${SYLIUS_VERSION}" ]; then
  printf "%b\n" "${GREEN}Creating Sylius project (version ${SYLIUS_VERSION}) in ${APP_DIR}...${ENDCOLOR}"
  CREATE_CMD="cd ${APP_SUBDIR} && composer create-project sylius/sylius-standard . '${SYLIUS_VERSION}' --no-interaction --no-scripts"
else
  printf "%b\n" "${GREEN}Creating Sylius project (newest) in ${APP_DIR}...${ENDCOLOR}"
  CREATE_CMD="cd ${APP_SUBDIR} && composer create-project sylius/sylius-standard . --no-interaction --no-scripts"
fi
# Create the project inside the web container but install into the current directory ('.') to avoid unsupported subdirectory errors.
if ! ddev exec "${CREATE_CMD}"; then
  printf "%b\n" "${RED}Composer create-project failed. Aborting.${ENDCOLOR}"
  exit 1
fi

### Copy ddev .env.dev.local if it exists
if [ -f "${DDEV_APP_FILES_DIR}/.env.dev.local" ]; then
  printf "%b\n" "${GREEN}Restoring .env.dev.local to project...${ENDCOLOR}"
  if ! cp -v "${DDEV_APP_FILES_DIR}/.env.dev.local" "${APP_DIR}/.env.dev.local"; then
    printf "%b\n" "${RED}Failed to copy .env.dev.local. You may need to restore it manually.${ENDCOLOR}"
  fi
else
  printf "%b\n" "${GREEN}No .env.dev.local backup found in ${DDEV_APP_FILES_DIR} â€” skipping restore.${ENDCOLOR}"
fi

### Rename README.md and LICENSE files to avoid conflicts
if [ -f "${DDEV_APPROOT}/README.md" ]; then
  printf "%b\n" "${GREEN}Renaming README.md to README-ddev-sylius.md to avoid conflicts...${ENDCOLOR}"
  mv "${DDEV_APPROOT}/README.md" "${DDEV_APPROOT}/README-ddev-sylius.md"
fi

if [ -f "${DDEV_APPROOT}/LICENSE" ]; then
  printf "%b\n" "${GREEN}Renaming LICENSE to LICENSE-ddev-sylius to avoid conflicts...${ENDCOLOR}"
  mv "${DDEV_APPROOT}/LICENSE" "${DDEV_APPROOT}/LICENSE-ddev-sylius"
fi

sleep 10;

### Move App contents to DDEV_APPROOT
# Use copy-then-remove to avoid "Device or resource busy" problems with mv across mounts
printf "%b\n" "${GREEN}Moving Sylius App contents to ${DDEV_APPROOT}...${ENDCOLOR}"
if cp -a "${APP_DIR}/." "${DDEV_APPROOT}/"; then
  printf "%b\n" "${GREEN}Copied Sylius App contents to ${DDEV_APPROOT}.${ENDCOLOR}"
  printf "%b\n" "${GREEN}Removing temporary App directory at ${APP_DIR}...${ENDCOLOR}"
  if rm -rf "${APP_DIR:?}"; then
    printf "%b\n" "${GREEN}Removed temporary App directory.${ENDCOLOR}"
  else
    printf "%b\n" "${RED}Failed to remove temporary App directory at ${APP_DIR}. Please remove it manually.${ENDCOLOR}"
  fi
else
  printf "%b\n" "${RED}Failed to copy Sylius App contents to ${DDEV_APPROOT}. Aborting.${ENDCOLOR}"
  printf "%b\n" "${RED}Sylius installation incomplete. Run ddev sylius-cleanup and start again.${ENDCOLOR}"
  exit 1
fi

### Install sylius (non-interactive)
printf "%b\n" "${GREEN}Running Sylius installer (non-interactive)...${ENDCOLOR}"
# Run installer inside the web container. Use `cd App` to reach the created project.
if ! ddev exec bin/console sylius:install --no-interaction; then
  printf "%b\n" "${RED}Sylius installer failed. Check the container output for details.${ENDCOLOR}"
  exit 1
fi

### Rebuild site
printf "%b\n" "${GREEN}Rebuilding site with ddev...${ENDCOLOR}"
if ! ddev rebuild-site; then
  printf "%b\n" "${RED}ddev rebuild-site failed. You may need to run 'ddev rebuild-site' manually.${ENDCOLOR}"
  exit 1
fi

printf "%b\n" "${GREEN}Sylius installation completed successfully.${ENDCOLOR}"
